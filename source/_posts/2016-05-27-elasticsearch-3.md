---
title: "Elasticsearch入门学习(3)——查询"
date: 2016-05-27 15:16:53 +0800
comments: true
toc: true
categories: Elasticsearch
tags : [elasticsearch , 大数据]
keywords: elasticsearch查询
---


>**ElasticSearch**提供了丰富的REST风格的API来满足不同的场景需求，本篇介绍Elasticsearch的查询相关的基础和高级操作。

<!-- more -->

## 检索文档

- **通过ID直接查询**
执行`HTTP GET`请求，通过`索引-类型-ID`便可以返回原始的JSON格式的文档，原始的JSON文档在`_source`字段里。

``` python
dislab@server:~$ curl -XGET 'http://server:9200/gps_data/20160205/3201000061%2010:20:54?pretty'
{
  "_index" : "gps_data",
  "_type" : "20160205",
  "_id" : "3201000061 10:20:54",
  "_version" : 1,
  "found" : true,
  "_source" : {
    "ZDBH" : "3201000061",
    "ROWKEY" : "3201000061 10:20:54",
    "GPSSJ" : "2016-02-05 10:20:54",
    "XLMC" : "80路"
  }
}
```

注意到`ID`字段插入了`%20`的字段，这是因为`curl`命令中不能有空格，若有空格则必须替换掉。

- **简单搜索**
简单搜索不需要指定`ID`,需要指定查询字符串，格式为`_search?q=key:value`

``` python
dislab@server:~$ curl -XGET  http://server:9200/gps_data/20160205/_search?q=GPSSJ:“2016-02-05 10:20:54”
{"took":695,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":10093722,"max_score":0.3666257,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201000158 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201000158","ROWKEY":"3201000158 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"13路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200106 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201200106","ROWKEY":"3201200106 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"170路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200154 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201200154","ROWKEY":"3201200154 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"125路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200126 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201200126","ROWKEY":"3201200126 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"8路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300190 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201300190","ROWKEY":"3201300190 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"48路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300169 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201300169","ROWKEY":"3201300169 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"48路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100008 05:05:05","_score":0.3666257,"_source":{"ZDBH":"3201100008","ROWKEY":"3201100008 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"306路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000166 05:05:05","_score":0.36632675,"_source":{"ZDBH":"3201000166","ROWKEY":"3201000166 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"13路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000179 05:05:05","_score":0.36632675,"_source":{"ZDBH":"3201000179","ROWKEY":"3201000179 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"13路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000019 05:05:05","_score":0.36632675,"_source":{"ZDBH":"3201000019","ROWKEY":"3201000019 05:05:05","GPSSJ":"2016-02-05 05:05:05","XLMC":"166路"}}]}}
```

- **DSL语句查询**
DSL(Domain Specific Language特定领域语言)以JSON请求体的形式出现，可以构建复杂的查询。
上述查询可写成如下的`DSL`查询方式

``` python
dislab@server:~$ curl -XGET 'http://server:9200/gps_data/20160205/_search' -d '
> {
>     "query" : {
>         "match" : {
>             "GPSSJ" : "2016-02-05 10:20:54"
>         }
>     }
> }
> '
{"took":854,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":10093722,"max_score":2.7672434,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201200801 20:54:10","_score":2.7672434,"_source":{"ZDBH":"3201200801","ROWKEY":"3201200801 20:54:10","GPSSJ":"2016-02-05 20:54:10","XLMC":"170路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300063 20:54:10","_score":2.7672434,"_source":{"ZDBH":"3201300063","ROWKEY":"3201300063 20:54:10","GPSSJ":"2016-02-05 20:54:10","XLMC":"D9路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000027 20:10:54","_score":2.7672434,"_source":{"ZDBH":"3201000027","ROWKEY":"3201000027 20:10:54","GPSSJ":"2016-02-05 20:10:54","XLMC":"7路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000193 10:54:20","_score":2.7672434,"_source":{"ZDBH":"3201000193","ROWKEY":"3201000193 10:54:20","GPSSJ":"2016-02-05 10:54:20","XLMC":"13路"}},{"_index":"gps_data","_type":"20160205","_id":"3201000115 20:10:54","_score":2.7672434,"_source":{"ZDBH":"3201000115","ROWKEY":"3201000115 20:10:54","GPSSJ":"2016-02-05 20:10:54","XLMC":"13路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 10:54:20","_score":2.7672434,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 10:54:20","GPSSJ":"2016-02-05 10:54:20","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200163 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201200163","ROWKEY":"3201200163 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"201路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200200 20:10:54","_score":2.7672434,"_source":{"ZDBH":"3201200200","ROWKEY":"3201200200 20:10:54","GPSSJ":"2016-02-05 20:10:54","XLMC":"170路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200127 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201200127","ROWKEY":"3201200127 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"125路"}},{"_index":"gps_data","_type":"20160205","_id":"3201200127 10:54:20","_score":2.7672434,"_source":{"ZDBH":"3201200127","ROWKEY":"3201200127 10:54:20","GPSSJ":"2016-02-05 10:54:20","XLMC":"125路"}}]}}
```

- **复杂DSL语句查询**
`DSL`查询可嵌套多种条件形成复杂查询。

``` python
dislab@server:~$ curl -XGET 'http://server:9200/gps_data/20160205/_search' -d '
> {
>     "query" : {
>         "filtered" : {
>             "filter" : {
>                 "range" : {
>                     "ZDBH" : { "gt" : 3201300108 }
>                 }
>             },
>             "query" : {
>                 "match" : {
>                     "GPSSJ" : "2016-02-05 10:20:54"
>                 }
>             }
>         }
>     }
> }
> '
{"took":657,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":645657,"max_score":2.7672434,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201300120 20:10:54","_score":2.7672434,"_source":{"ZDBH":"3201300120","ROWKEY":"3201300120 20:10:54","GPSSJ":"2016-02-05 20:10:54","XLMC":"41路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300220 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201300220","ROWKEY":"3201300220 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"306路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300131 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201300131","ROWKEY":"3201300131 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"48路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300162 10:54:20","_score":2.7672434,"_source":{"ZDBH":"3201300162","ROWKEY":"3201300162 10:54:20","GPSSJ":"2016-02-05 10:54:20","XLMC":"182路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300177 20:54:10","_score":2.7672434,"_source":{"ZDBH":"3201300177","ROWKEY":"3201300177 20:54:10","GPSSJ":"2016-02-05 20:54:10","XLMC":"56路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300165 10:54:20","_score":2.7672434,"_source":{"ZDBH":"3201300165","ROWKEY":"3201300165 10:54:20","GPSSJ":"2016-02-05 10:54:20","XLMC":"48路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300115 20:54:10","_score":2.7672434,"_source":{"ZDBH":"3201300115","ROWKEY":"3201300115 20:54:10","GPSSJ":"2016-02-05 20:54:10","XLMC":"48路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300120 20:54:10","_score":2.7672434,"_source":{"ZDBH":"3201300120","ROWKEY":"3201300120 20:54:10","GPSSJ":"2016-02-05 20:54:10","XLMC":"41路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300171 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201300171","ROWKEY":"3201300171 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"56路"}},{"_index":"gps_data","_type":"20160205","_id":"3201300200 10:20:54","_score":2.7672434,"_source":{"ZDBH":"3201300200","ROWKEY":"3201300200 10:20:54","GPSSJ":"2016-02-05 10:20:54","XLMC":"306路"}}]}}dislab@server:~$
```
上述查询主要包括一个区间过滤器和match语句。

- **全文搜索**
使用`match`匹配计算相关性，根据结果相关性评分来对结果集进行排序。

``` python
dislab@server:~$ curl -XGET 'http://server:9200/gps_data/20160205/_search' -d '
{
     "query" : {
         "match" : {
             "XLMC" : "57"
         }
     }
 }
'
{"took":146,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":143481,"max_score":2.9686642,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:12","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:12","GPSSJ":"2016-02-05 07:17:12","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:38","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:38","GPSSJ":"2016-02-05 07:17:38","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:42","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:42","GPSSJ":"2016-02-05 07:17:42","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:01","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:01","GPSSJ":"2016-02-05 07:18:01","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:15","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:15","GPSSJ":"2016-02-05 07:18:15","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:17","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:17","GPSSJ":"2016-02-05 07:18:17","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:23","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:23","GPSSJ":"2016-02-05 07:18:23","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:30","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:30","GPSSJ":"2016-02-05 07:18:30","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:48","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:48","GPSSJ":"2016-02-05 07:18:48","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:49","_score":2.9686642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:49","GPSSJ":"2016-02-05 07:18:49","XLMC":"57路"}}]}}
```

- **短语搜索**
关键字之间是`与`关系的短语搜素，要求在搜索过程中关键字是相邻的。

``` python
curl -XGET 'http://server:9200/gps_data/20160205/_search' -d '
{
    "query" : {
        "match_phrase" : {
            "XLMC" : "57 路"
        }
    }
}
'
{"took":236,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":143481,"max_score":3.5936642,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:22:40","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:22:40","GPSSJ":"2016-02-05 14:22:40","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:22:52","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:22:52","GPSSJ":"2016-02-05 14:22:52","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:23:06","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:23:06","GPSSJ":"2016-02-05 14:23:06","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:23:37","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:23:37","GPSSJ":"2016-02-05 14:23:37","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:23:39","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:23:39","GPSSJ":"2016-02-05 14:23:39","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:23:47","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:23:47","GPSSJ":"2016-02-05 14:23:47","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:23:58","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:23:58","GPSSJ":"2016-02-05 14:23:58","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:24:31","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:24:31","GPSSJ":"2016-02-05 14:24:31","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:24:35","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:24:35","GPSSJ":"2016-02-05 14:24:35","XLMC":"57路"}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 14:25:15","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 14:25:15","GPSSJ":"2016-02-05 14:25:15","XLMC":"57路"}}]}}
```

- **搜索结果高亮**
使用`highlight`高亮搜索到的匹配关键字。

``` python
curl -XGET 'http://server:9200/gps_data/20160205/_search' -d '
{
    "query" : {
        "match_phrase" : {
            "XLMC" : "57 路"
        }
    },
    "highlight": {
        "fields" : {
            "XLMC" : {}
        }
    }
}
'
{"took":375,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":143481,"max_score":3.5936642,"hits":[{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:12","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:12","GPSSJ":"2016-02-05 07:17:12","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:38","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:38","GPSSJ":"2016-02-05 07:17:38","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:17:42","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:17:42","GPSSJ":"2016-02-05 07:17:42","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:01","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:01","GPSSJ":"2016-02-05 07:18:01","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:15","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:15","GPSSJ":"2016-02-05 07:18:15","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:17","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:17","GPSSJ":"2016-02-05 07:18:17","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:23","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:23","GPSSJ":"2016-02-05 07:18:23","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:30","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:30","GPSSJ":"2016-02-05 07:18:30","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:48","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:48","GPSSJ":"2016-02-05 07:18:48","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}},{"_index":"gps_data","_type":"20160205","_id":"3201100090 07:18:49","_score":3.5936642,"_source":{"ZDBH":"3201100090","ROWKEY":"3201100090 07:18:49","GPSSJ":"2016-02-05 07:18:49","XLMC":"57路"},"highlight":{"XLMC":["<em>57</em><em>路</em>"]}}]}}
```